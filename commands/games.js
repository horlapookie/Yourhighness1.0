const config = require('../config');
const db = require('../lib/database');

const commands = {
    // Akinator game
    akinator: async (conn, msg, args) => {
        try {
            await msg.reply(
                `üßû *AKINATOR* üßû\n\n` +
                `Think of a character (real or fictional) and I'll try to guess it!\n\n` +
                `‚ö†Ô∏è Akinator integration is currently under development.\n` +
                `This feature requires external API integration.\n\n` +
                `_Coming soon in yourh√Øghness_\n` +
                `üîó ${config.CHANNEL_URL}`
            );
        } catch (error) {
            console.error('Error in akinator command:', error);
            await msg.reply('‚ùå Failed to start Akinator game.');
        }
    },

    // Answer quiz question
    answer: async (conn, msg, args) => {
        try {
            const quiz = db.getGame('quiz', msg.from);
            if (!quiz) {
                return msg.reply('‚ùå No active quiz found. Use `+start-quiz` to begin a quiz.');
            }

            if (!args.length) {
                return msg.reply('‚ùå Please provide your answer.\n\nUsage: `+answer <option>` (e.g., +answer A)');
            }

            const userAnswer = args[0].toUpperCase();
            const correctAnswer = quiz.currentQuestion.correct;

            if (userAnswer === correctAnswer) {
                quiz.score += 10;
                quiz.correct++;
                await msg.react('‚úÖ');
                await msg.reply(
                    `‚úÖ *CORRECT!* ‚úÖ\n\n` +
                    `üéØ Score: +10 points\n` +
                    `üìä Total Score: ${quiz.score}\n` +
                    `‚ú® Correct Answers: ${quiz.correct}/${quiz.questionNumber}\n\n` +
                    `‚è≥ Next question in 3 seconds...`
                );
                
                setTimeout(async () => {
                    if (quiz.questionNumber >= 10) {
                        await commands['end-quiz'](conn, msg, []);
                    } else {
                        await commands['next-question'](conn, msg, []);
                    }
                }, 3000);
            } else {
                quiz.incorrect++;
                await msg.react('‚ùå');
                await msg.reply(
                    `‚ùå *INCORRECT!* ‚ùå\n\n` +
                    `‚úÖ Correct Answer: ${correctAnswer}\n` +
                    `üìä Your Score: ${quiz.score}\n` +
                    `‚ùå Wrong Answers: ${quiz.incorrect}/${quiz.questionNumber}\n\n` +
                    `‚è≥ Next question in 3 seconds...`
                );
                
                setTimeout(async () => {
                    if (quiz.questionNumber >= 10) {
                        await commands['end-quiz'](conn, msg, []);
                    } else {
                        await commands['next-question'](conn, msg, []);
                    }
                }, 3000);
            }

            db.setGame('quiz', msg.from, quiz);

        } catch (error) {
            console.error('Error in answer command:', error);
            await msg.reply('‚ùå Failed to process your answer.');
        }
    },

    // Dots and boxes game
    'dots-and-boxes': async (conn, msg, args) => {
        try {
            if (!msg.isGroup) {
                return msg.reply('‚ùå Dots and Boxes can only be played in groups.');
            }

            const game = {
                board: Array(4).fill(null).map(() => Array(4).fill('¬∑')),
                players: [msg.sender],
                currentPlayer: 0,
                scores: [0],
                lines: [],
                status: 'waiting'
            };

            db.setGame('dots-and-boxes', msg.from, game);

            await msg.reply(
                `‚ö´ *DOTS AND BOXES* ‚ö´\n\n` +
                `üéÆ Game created by ${msg.pushName || msg.sender.split('@')[0]}\n\n` +
                `üìã Waiting for another player to join...\n` +
                `‚ö° Use \`${config.PREFIX}join-dots\` to join the game\n\n` +
                `üìñ How to play:\n` +
                `‚Ä¢ Draw lines between dots\n` +
                `‚Ä¢ Complete boxes to earn points\n` +
                `‚Ä¢ Player with most boxes wins!\n\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in dots-and-boxes command:', error);
            await msg.reply('‚ùå Failed to start Dots and Boxes game.');
        }
    },

    // Dragon game (RPG style)
    dragon: async (conn, msg, args) => {
        try {
            const user = db.getUser(msg.sender);
            
            if (!user.dragon) {
                user.dragon = {
                    name: 'Baby Dragon',
                    level: 1,
                    hp: 100,
                    maxHp: 100,
                    attack: 10,
                    defense: 5,
                    exp: 0,
                    maxExp: 100,
                    lastFed: null,
                    lastTrained: null
                };
                db.updateUser(msg.sender, user);
            }

            const dragon = user.dragon;
            const hunger = dragon.lastFed ? 
                Math.floor((Date.now() - new Date(dragon.lastFed).getTime()) / (1000 * 60 * 60)) : 24;

            let status = '';
            if (hunger < 6) status = 'üòä Happy';
            else if (hunger < 12) status = 'üòê Content';
            else if (hunger < 18) status = 'üòû Hungry';
            else status = 'üòµ Starving';

            await msg.reply(
                `üêâ *YOUR DRAGON* üêâ\n\n` +
                `üè∑Ô∏è Name: ${dragon.name}\n` +
                `‚≠ê Level: ${dragon.level}\n` +
                `‚ù§Ô∏è HP: ${dragon.hp}/${dragon.maxHp}\n` +
                `‚öîÔ∏è Attack: ${dragon.attack}\n` +
                `üõ°Ô∏è Defense: ${dragon.defense}\n` +
                `‚ú® EXP: ${dragon.exp}/${dragon.maxExp}\n` +
                `üòä Status: ${status}\n\n` +
                `üìñ Commands:\n` +
                `‚Ä¢ \`${config.PREFIX}feed-dragon\` - Feed your dragon\n` +
                `‚Ä¢ \`${config.PREFIX}train-dragon\` - Train your dragon\n` +
                `‚Ä¢ \`${config.PREFIX}dragon-battle\` - Battle other dragons\n\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in dragon command:', error);
            await msg.reply('‚ùå Failed to display dragon information.');
        }
    },

    // Forfeit quiz
    'forfeit-quiz': async (conn, msg, args) => {
        try {
            const quiz = db.getGame('quiz', msg.from);
            if (!quiz) {
                return msg.reply('‚ùå No active quiz found to forfeit.');
            }

            if (quiz.player !== msg.sender) {
                return msg.reply('‚ùå You are not the quiz player.');
            }

            db.deleteGame('quiz', msg.from);
            
            await msg.reply(
                `‚ùå *QUIZ FORFEITED* ‚ùå\n\n` +
                `üéÆ Player: ${msg.pushName || msg.sender.split('@')[0]}\n` +
                `üìä Final Score: ${quiz.score} points\n` +
                `‚úÖ Correct: ${quiz.correct}\n` +
                `‚ùå Incorrect: ${quiz.incorrect}\n` +
                `‚ùì Questions Answered: ${quiz.questionNumber - 1}/10\n\n` +
                `_Better luck next time! - yourh√Øghness_\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in forfeit-quiz command:', error);
            await msg.reply('‚ùå Failed to forfeit quiz.');
        }
    },

    // Hangman game
    hangman: async (conn, msg, args) => {
        try {
            const words = [
                'JAVASCRIPT', 'PYTHON', 'COMPUTER', 'WHATSAPP', 'TELEGRAM',
                'ANDROID', 'INTERNET', 'WEBSITE', 'DATABASE', 'ALGORITHM'
            ];
            
            const word = words[Math.floor(Math.random() * words.length)];
            const guessed = Array(word.length).fill('_');
            
            const game = {
                word,
                guessed,
                wrongGuesses: [],
                attempts: 6,
                player: msg.sender,
                status: 'active'
            };

            db.setGame('hangman', msg.from, game);

            await msg.reply(
                `üéØ *HANGMAN GAME* üéØ\n\n` +
                `üéÆ Player: ${msg.pushName || msg.sender.split('@')[0]}\n\n` +
                `üìù Word: ${guessed.join(' ')}\n` +
                `‚ùå Wrong Guesses: ${game.wrongGuesses.join(', ') || 'None'}\n` +
                `üíÄ Attempts Left: ${game.attempts}\n\n` +
                `üìñ Use \`${config.PREFIX}guess <letter>\` to guess a letter\n` +
                `üìñ Use \`${config.PREFIX}solve <word>\` to solve the word\n\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in hangman command:', error);
            await msg.reply('‚ùå Failed to start hangman game.');
        }
    },

    // Start quiz
    'start-quiz': async (conn, msg, args) => {
        try {
            const existingQuiz = db.getGame('quiz', msg.from);
            if (existingQuiz) {
                return msg.reply('‚ùå A quiz is already active in this chat. Finish it first or use `+forfeit-quiz`.');
            }

            const quizQuestions = [
                {
                    question: "What is the capital of France?",
                    options: { A: "London", B: "Berlin", C: "Paris", D: "Madrid" },
                    correct: "C"
                },
                {
                    question: "Which planet is known as the Red Planet?",
                    options: { A: "Venus", B: "Mars", C: "Jupiter", D: "Saturn" },
                    correct: "B"
                },
                {
                    question: "What is 2 + 2?",
                    options: { A: "3", B: "4", C: "5", D: "6" },
                    correct: "B"
                },
                {
                    question: "Who painted the Mona Lisa?",
                    options: { A: "Van Gogh", B: "Picasso", C: "Da Vinci", D: "Michelangelo" },
                    correct: "C"
                },
                {
                    question: "What is the largest ocean on Earth?",
                    options: { A: "Atlantic", B: "Indian", C: "Arctic", D: "Pacific" },
                    correct: "D"
                }
            ];

            const quiz = {
                questions: quizQuestions,
                currentQuestionIndex: 0,
                questionNumber: 1,
                score: 0,
                correct: 0,
                incorrect: 0,
                player: msg.sender,
                startTime: new Date()
            };

            quiz.currentQuestion = quiz.questions[0];
            db.setGame('quiz', msg.from, quiz);

            const q = quiz.currentQuestion;
            await msg.reply(
                `üß† *QUIZ STARTED* üß†\n\n` +
                `üéÆ Player: ${msg.pushName || msg.sender.split('@')[0]}\n` +
                `‚ùì Question ${quiz.questionNumber}/10\n\n` +
                `üìù ${q.question}\n\n` +
                `A) ${q.options.A}\n` +
                `B) ${q.options.B}\n` +
                `C) ${q.options.C}\n` +
                `D) ${q.options.D}\n\n` +
                `‚ö° Use \`${config.PREFIX}answer <option>\` to answer\n` +
                `‚ùå Use \`${config.PREFIX}forfeit-quiz\` to quit\n\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in start-quiz command:', error);
            await msg.reply('‚ùå Failed to start quiz.');
        }
    },

    // Tic Tac Toe
    tictactoe: async (conn, msg, args) => {
        try {
            if (!msg.isGroup) {
                return msg.reply('‚ùå Tic Tac Toe can only be played in groups.');
            }

            const existingGame = db.getGame('tictactoe', msg.from);
            if (existingGame) {
                return msg.reply('‚ùå A Tic Tac Toe game is already active in this group.');
            }

            const game = {
                board: Array(9).fill(' '),
                players: [msg.sender],
                currentPlayer: 0,
                status: 'waiting',
                symbols: ['‚ùå', '‚≠ï'],
                createdAt: new Date()
            };

            db.setGame('tictactoe', msg.from, game);

            await msg.reply(
                `‚≠ï *TIC TAC TOE* ‚ùå\n\n` +
                `üéÆ Game created by ${msg.pushName || msg.sender.split('@')[0]}\n\n` +
                `üìã Waiting for another player to join...\n` +
                `‚ö° Use \`${config.PREFIX}join-ttt\` to join the game\n\n` +
                `üìñ How to play:\n` +
                `‚Ä¢ Players take turns placing symbols\n` +
                `‚Ä¢ Get 3 in a row to win!\n` +
                `‚Ä¢ Use \`${config.PREFIX}place <position>\` (1-9)\n\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in tictactoe command:', error);
            await msg.reply('‚ùå Failed to start Tic Tac Toe game.');
        }
    },

    // Helper function for next quiz question
    'next-question': async (conn, msg, args) => {
        try {
            const quiz = db.getGame('quiz', msg.from);
            if (!quiz) return;

            quiz.currentQuestionIndex++;
            quiz.questionNumber++;
            
            if (quiz.currentQuestionIndex >= quiz.questions.length) {
                return commands['end-quiz'](conn, msg, []);
            }

            quiz.currentQuestion = quiz.questions[quiz.currentQuestionIndex];
            db.setGame('quiz', msg.from, quiz);

            const q = quiz.currentQuestion;
            await msg.reply(
                `üß† *QUIZ CONTINUES* üß†\n\n` +
                `üìä Score: ${quiz.score} points\n` +
                `‚ùì Question ${quiz.questionNumber}/10\n\n` +
                `üìù ${q.question}\n\n` +
                `A) ${q.options.A}\n` +
                `B) ${q.options.B}\n` +
                `C) ${q.options.C}\n` +
                `D) ${q.options.D}\n\n` +
                `‚ö° Use \`${config.PREFIX}answer <option>\` to answer\n\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in next-question:', error);
        }
    },

    // Helper function to end quiz
    'end-quiz': async (conn, msg, args) => {
        try {
            const quiz = db.getGame('quiz', msg.from);
            if (!quiz) return;

            db.deleteGame('quiz', msg.from);
            
            let grade = '';
            const percentage = (quiz.correct / 10) * 100;
            if (percentage >= 90) grade = 'üèÜ Excellent!';
            else if (percentage >= 80) grade = 'ü•á Great!';
            else if (percentage >= 70) grade = 'ü•à Good!';
            else if (percentage >= 60) grade = 'ü•â Average';
            else grade = 'üìö Study More!';

            // Update user XP and coins
            const user = db.getUser(msg.sender);
            user.xp += quiz.score;
            user.coins += Math.floor(quiz.score / 2);
            db.updateUser(msg.sender, user);

            await msg.reply(
                `üéâ *QUIZ COMPLETED* üéâ\n\n` +
                `üéÆ Player: ${msg.pushName || msg.sender.split('@')[0]}\n` +
                `üìä Final Score: ${quiz.score} points\n` +
                `‚úÖ Correct: ${quiz.correct}/10\n` +
                `‚ùå Incorrect: ${quiz.incorrect}/10\n` +
                `üìà Accuracy: ${percentage}%\n` +
                `üèÖ Grade: ${grade}\n\n` +
                `üéÅ Rewards:\n` +
                `‚Ä¢ +${quiz.score} XP\n` +
                `‚Ä¢ +${Math.floor(quiz.score / 2)} coins\n\n` +
                `_Great job! - yourh√Øghness_\n` +
                `üîó ${config.CHANNEL_URL}`
            );

        } catch (error) {
            console.error('Error in end-quiz:', error);
        }
    }
};

module.exports = { commands };
